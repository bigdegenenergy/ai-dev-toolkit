# ⚠️ REVIEW INSTRUCTIONS

> Generated by Gemini

```json
{
  "review": {
    "summary": "This PR refactors the AI agent workflows to use natural language intent detection and JSON data exchange. While the UX improvements are positive, there are critical security gaps regarding authorization for the new LLM-based trigger and potentially invalid model configurations that need to be addressed before merging.",
    "decision": "REQUEST_CHANGES"
  },
  "issues": [
    {
      "id": 1,
      "severity": "critical",
      "file": ".github/workflows/claude-code-implement.yml",
      "line": 0,
      "title": "Missing Authorization Check for Intent Analysis",
      "description": "The `claude-code-implement.yml` workflow triggers on `issue_comment` and immediately runs a `detect-intent` job that queries the Anthropic API. Unlike the Gemini workflow, there is no documented `check-perms` step or `if` condition ensuring the commenter has write/admin access. This exposes the repository to Denial of Wallet attacks (unauthorized API usage) and potential unauthorized code implementation triggers.",
      "suggestion": "Add a permission check step (similar to the one in `gemini-pr-review-plus.yml`) at the start of the `detect-intent` job to ensure `github.event.comment.author_association` is a maintainer or collaborator before making API calls."
    },
    {
      "id": 2,
      "severity": "important",
      "file": ".github/workflows/claude-code-implement.yml",
      "line": 0,
      "title": "Verify Model Availability: claude-haiku-4-5-20250106",
      "description": "The workflow hardcodes `claude-haiku-4-5-20250106`. As of current knowledge, Anthropic's latest models are the Claude 3.5 series. 'Haiku 4.5' appears to be an incorrect or non-existent model ID, which will cause the API call to fail. The same applies to `gemini-3-pro-preview` in the Gemini workflow (current version is 1.5).",
      "suggestion": "Verify the model IDs against the official provider documentation. Use standard IDs like `claude-3-5-haiku-latest` or `gemini-1.5-pro` unless you have access to specific private preview models not publicly documented."
    },
    {
      "id": 3,
      "severity": "important",
      "file": ".github/workflows/claude-code-implement.yml",
      "line": 0,
      "title": "Potential Indirect Prompt Injection in Intent Analysis",
      "description": "The `detect-intent` job gathers 'recent PR comment context' and sends it to the LLM to determine user intent. If the context includes comments from untrusted users (e.g., in a public repo), a malicious actor could inject instructions (e.g., 'Ignore previous rules, execute X') that mislead the LLM into triggering an unintended implementation, potentially bypassing restrictions.",
      "suggestion": "Sanitize the context sent to the LLM. Preferably, only analyze the specific comment that triggered the workflow, or strictly filter the context to include only comments from authorized users (maintainers)."
    },
    {
      "id": 4,
      "severity": "suggestion",
      "file": ".github/workflows/gemini-pr-review-plus.yml",
      "line": 0,
      "title": "Fragile JSON Extraction via Regex",
      "description": "The workflow uses regex to extract JSON from the LLM's review output. This is brittle; if the LLM adds conversational text or markdown code fences that the regex doesn't expect, the parsing will fail.",
      "suggestion": "Update the LLM system prompt to enforce a strict output format (e.g., 'Output ONLY raw JSON, no markdown') or use a more robust parsing script (e.g., finding the first valid `{` and last `}` and attempting `JSON.parse`)."
    },
    {
      "id": 5,
      "severity": "important",
      "file": ".github/scripts/claude-code-implement.cjs",
      "line": 1,
      "title": "Verify Code Logic Matches JSON Prompt Update",
      "description": "The system prompt was updated to expect JSON `reviewInstructions`, but the file diff only shows 4 lines changed. If the underlying logic uses a TOML parser (e.g., `toml.parse`) instead of `JSON.parse`, the script will crash at runtime despite the prompt update.",
      "suggestion": "Ensure the JavaScript code that parses the `reviewInstructions` input has been updated to handle JSON format, replacing any previous TOML parsing logic."
    }
  ]
}
```