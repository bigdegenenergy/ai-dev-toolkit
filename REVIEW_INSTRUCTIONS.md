# ⚠️ REVIEW INSTRUCTIONS

> Generated by Gemini

```json
{
  "review": {
    "summary": "This PR introduces significant new capabilities including the Lobster workflow engine and Gateway ChatOps. However, the Python implementation of the workflow engine (`.claude/workflows/lobster/`) contains critical cross-platform compatibility issues (Windows support) and several security vulnerabilities regarding input validation, path traversal, and injection risks that must be addressed before merging.",
    "decision": "REQUEST_CHANGES"
  },
  "issues": [
    {
      "id": 1,
      "severity": "critical",
      "file": ".claude/workflows/lobster/state.py",
      "line": 3,
      "title": "Windows Incompatibility (ImportError)",
      "description": "The module imports and uses `fcntl` for file locking, which is Unix-specific. This will cause the application to crash immediately on Windows environments, breaking the toolkit for Windows users.",
      "suggestion": "Use a cross-platform file locking library (e.g., `portalocker`) or implement OS-specific locking logic using `msvcrt` for Windows and `fcntl` for Unix."
    },
    {
      "id": 2,
      "severity": "critical",
      "file": ".claude/workflows/lobster/state.py",
      "line": 38,
      "title": "Path Traversal Vulnerability",
      "description": "The `workflow_id` is used directly to construct file paths (`self.artifacts_dir / f\"{workflow_id}.json\"`). If this ID is derived from user input (CLI or Gateway) without sanitization, malicious actors could read or write arbitrary files on the system.",
      "suggestion": "Validate that `workflow_id` contains only safe characters (e.g., alphanumeric and hyphens) or use `os.path.basename` to strip directory components before using it in file operations."
    },
    {
      "id": 3,
      "severity": "important",
      "file": ".claude/workflows/lobster/engine.py",
      "line": 120,
      "title": "Command Injection Risk in Variable Substitution",
      "description": "The `_substitute_variables` method performs naive string replacement (`text.replace`). If variables are injected into a `StepType.SHELL` command string, and the variable content includes shell metacharacters (e.g., `;`, `&&`, `|`), it allows arbitrary command execution.",
      "suggestion": "For shell commands, avoid string interpolation. Instead, pass variables as an environment dictionary to the subprocess call, or strictly escape inputs using `shlex.quote` if interpolation is unavoidable."
    },
    {
      "id": 4,
      "severity": "important",
      "file": ".claude/workflows/lobster/gates.py",
      "line": 71,
      "title": "Restrictive Regex and Documentation Mismatch",
      "description": "The regex `r\"^steps\\.(\\w+)\\.outputs\\.(\\w+)$\"` is too restrictive. It fails to support step names with hyphens (e.g., `test-unit`, which is common in YAML) and does not support the bracket notation (`steps['test-unit']`) claimed in the function's docstring.",
      "suggestion": "Update the regex to support hyphens (e.g., `[\\w-]+`) and implement parsing for the documented bracket notation to ensure usability with standard naming conventions."
    },
    {
      "id": 5,
      "severity": "important",
      "file": ".claude/gateway/commands.py",
      "line": 65,
      "title": "Prompt Injection Vulnerability",
      "description": "User arguments are directly concatenated into the XML prompt structure. A malicious user could include closing tags (e.g., `</user_arguments>`) in their message to break out of the data context and inject system instructions to the LLM.",
      "suggestion": "Sanitize `args` to escape XML special characters (`<`, `>`, `&`) before insertion into the prompt template."
    }
  ]
}
```