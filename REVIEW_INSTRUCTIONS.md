# ⚠️ REVIEW INSTRUCTIONS

> Generated by Gemini

```json
{
  "review": {
    "summary": "The PR introduces significant AI automation features but contains blocking issues regarding git context handling in event-driven workflows and a critical security vulnerability allowing plan injection. Additionally, a temporary review artifact was accidentally included.",
    "decision": "REQUEST_CHANGES"
  },
  "issues": [
    {
      "id": 1,
      "severity": "critical",
      "file": ".github/workflows/claude-research-implement.yml",
      "line": 35,
      "title": "Broken checkout logic for PR comments",
      "description": "The expression `github.event.issue.pull_request.head.ref` is undefined for `issue_comment` events. While the `issue` object contains a `pull_request` property (an object with URLs), it does not contain `head` or `ref` data. This causes the workflow to fall back to `github.ref` (the default branch) or fail, resulting in the AI analyzing and implementing changes on the wrong branch.",
      "suggestion": "Use an `actions/github-script` step to fetch the Pull Request details via the API (using `context.issue.number`) to retrieve the correct `head.ref`, and pass it as an output to the checkout step."
    },
    {
      "id": 2,
      "severity": "critical",
      "file": ".github/workflows/claude-research-implement.yml",
      "line": 150,
      "title": "Plan Injection / Confused Deputy Vulnerability",
      "description": "The workflow parses previous comments to find a '## Research Summary' to implement. While it validates the user *triggering* the workflow, it does NOT validate the user who *wrote* the plan. A malicious user could post a comment with a harmful plan, and if a maintainer subsequently triggers the implementation, the bot will execute the malicious plan.",
      "suggestion": "Update the script to verify that the comment containing the 'Research Summary' was authored by a trusted user (e.g., the bot itself, the original issue author, or a repository maintainer) before accepting it as the execution plan."
    },
    {
      "id": 3,
      "severity": "critical",
      "file": ".github/workflows/claude.yml",
      "line": 52,
      "title": "Broken checkout logic and invalid context access",
      "description": "Similar to issue #1, the checkout ref logic fails for `issue_comment` events on PRs. Furthermore, for `pull_request_review` and `pull_request_review_comment` triggers, `github.event.issue` is undefined, which will cause the expression `github.event.issue.pull_request` to fail or behave unpredictably.",
      "suggestion": "Standardize the checkout logic by fetching the head ref via API for comment-based triggers. Ensure the workflow handles the different payload structures of `issue_comment` vs `pull_request_review` correctly."
    },
    {
      "id": 4,
      "severity": "important",
      "file": "REVIEW_INSTRUCTIONS.md",
      "line": 1,
      "title": "Temporary file committed",
      "description": "The `REVIEW_INSTRUCTIONS.md` file appears to be a generated artifact containing review instructions and existing bug reports (ironically identifying issues with the PR itself). It should not be part of the repository.",
      "suggestion": "Delete this file."
    },
    {
      "id": 5,
      "severity": "important",
      "file": ".github/mcp-config.json.template",
      "line": 5,
      "title": "Unpinned package execution in template",
      "description": "The template uses `npx -y` which executes the latest version of packages immediately. This creates a supply chain risk where a compromised upstream package or a dependency confusion attack could execute malicious code immediately upon server start.",
      "suggestion": "Pin the versions of the MCP server packages in the template (e.g., `npx -y @modelcontextprotocol/server-github@0.x.x`) to ensure stability and security."
    }
  ]
}
```